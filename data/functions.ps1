# FAKE data for dev (to get super quick response during testing)
$FAKETESTDATA = ('Starting to detect image: https://webcam.wpzw.de/webcam.jpg
Inference time: 47.95379877090454
{
  "num_objects": 100,
  "detections": [
    {
      "box": [
        0.27112290263175964,
        0.7697577476501465,
        0.39190664887428284,
        0.8680963516235352
      ],
      "class_label": "Car",
      "score": 0.26753756403923035
    },
    {
      "box": [
        0.7843207120895386,
        0.6210172176361084,
        0.9845614433288574,
        0.7952810525894165
      ],
      "class_label": "Tree",
      "score": 0.24462465941905975
    },
    {
      "box": [
        0.44082123041152954,
        0.3470805287361145,
        0.8454386591911316,
        0.7668412327766418
      ],
      "class_label": "House",
      "score": 0.2047627866268158
    },
    {
      "box": [
        0.36999133229255676,
        0.14882829785346985,
        0.5034972429275513,
        0.23046642541885376
      ],
      "class_label": "Tree",
      "score": 0.19031371176242828
    },
    {
      "box": [
        0.00035700201988220215,
        0.8353239893913269,
        0.18546448647975922,
        0.9985001683235168
      ],
      "class_label": "Tree",
      "score": 0.18785573542118073
    },
    {
      "box": [
        0.37329304218292236,
        0.28559601306915283,
        0.5738659501075745,
        0.49743008613586426
      ],
      "class_label": "House",
      "score": 0.1791374534368515
    },
    {
      "box": [
        0.0,
        0.9418913722038269,
        0.14379698038101196,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.16633644700050354
    },
    {
      "box": [
        0.013684451580047607,
        0.8352323770523071,
        0.1447533220052719,
        0.9118376970291138
      ],
      "class_label": "Tree",
      "score": 0.1615591198205948
    },
    {
      "box": [
        0.27112290263175964,
        0.7697577476501465,
        0.39190664887428284,
        0.8680963516235352
      ],
      "class_label": "Land vehicle",
      "score": 0.14903558790683746
    },
    {
      "box": [
        0.4916674494743347,
        0.25205808877944946,
        0.6798502802848816,
        0.43343228101730347
      ],
      "class_label": "House",
      "score": 0.1457010954618454
    },
    {
      "box": [
        0.26744839549064636,
        0.3120703101158142,
        0.31465068459510803,
        0.3730403184890747
      ],
      "class_label": "Plant",
      "score": 0.1448937952518463
    },
    {
      "box": [
        0.007191933691501617,
        0.862201452255249,
        0.13240399956703186,
        0.9688447713851929
      ],
      "class_label": "Tree",
      "score": 0.14477947354316711
    },
    {
      "box": [
        0.3919394314289093,
        0.31308484077453613,
        0.6063485145568848,
        0.5324183702468872
      ],
      "class_label": "House",
      "score": 0.14085504412651062
    },
    {
      "box": [
        4.186853766441345e-05,
        0.8573722839355469,
        0.08389338850975037,
        0.9858274459838867
      ],
      "class_label": "Tree",
      "score": 0.13979701697826385
    },
    {
      "box": [
        0.0006583258509635925,
        0.8297087550163269,
        0.07065410166978836,
        0.9357457756996155
      ],
      "class_label": "Tree",
      "score": 0.13934192061424255
    },
    {
      "box": [
        0.7955862879753113,
        0.6880629658699036,
        0.8749849200248718,
        0.749716579914093
      ],
      "class_label": "Plant",
      "score": 0.13774637877941132
    },
    {
      "box": [
        0.0,
        0.8074214458465576,
        0.1598302274942398,
        0.9636392593383789
      ],
      "class_label": "Tree",
      "score": 0.1359061747789383
    },
    {
      "box": [
        0.002201549708843231,
        0.8980809450149536,
        0.1916983425617218,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.13574384152889252
    },
    {
      "box": [
        0.39166200160980225,
        0.25745782256126404,
        0.6062484979629517,
        0.44033822417259216
      ],
      "class_label": "House",
      "score": 0.1351539045572281
    },
    {
      "box": [
        0.4576233923435211,
        0.2862904667854309,
        0.6827076077461243,
        0.4853460192680359
      ],
      "class_label": "House",
      "score": 0.1310143917798996
    },
    {
      "box": [
        0.3404460549354553,
        0.1341562718153,
        0.5461001992225647,
        0.2667577266693115
      ],
      "class_label": "Tree",
      "score": 0.12734827399253845
    },
    {
      "box": [
        0.3016093671321869,
        0.21079877018928528,
        0.38138923048973083,
        0.28428056836128235
      ],
      "class_label": "Tree",
      "score": 0.12676964700222015
    },
    {
      "box": [
        0.0,
        0.8095777630805969,
        0.1010468602180481,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.124892458319664
    },
    {
      "box": [
        0.07632678747177124,
        0.37081363797187805,
        0.29130616784095764,
        0.540290892124176
      ],
      "class_label": "Tree",
      "score": 0.12123283743858337
    },
    {
      "box": [
        0.0,
        0.4826691746711731,
        0.35999882221221924,
        0.9638615250587463
      ],
      "class_label": "Tree",
      "score": 0.12018148601055145
    },
    {
      "box": [
        0.3016093671321869,
        0.21079877018928528,
        0.38138923048973083,
        0.28428056836128235
      ],
      "class_label": "Plant",
      "score": 0.12001262605190277
    },
    {
      "box": [
        0.016738392412662506,
        0.413488507270813,
        0.23368513584136963,
        0.5651670098304749
      ],
      "class_label": "Tree",
      "score": 0.11652510613203049
    },
    {
      "box": [
        0.0,
        0.4861757159233093,
        0.194120854139328,
        0.6593456864356995
      ],
      "class_label": "Tree",
      "score": 0.11524055898189545
    },
    {
      "box": [
        0.01620585471391678,
        0.29857730865478516,
        0.2604404091835022,
        0.4806404113769531
      ],
      "class_label": "Tree",
      "score": 0.11512596160173416
    },
    {
      "box": [
        0.40671050548553467,
        0.13682256639003754,
        0.5002828240394592,
        0.1746184378862381
      ],
      "class_label": "Tree",
      "score": 0.11496973782777786
    },
    {
      "box": [
        0.08752128481864929,
        0.06149524450302124,
        0.45775797963142395,
        0.6807562708854675
      ],
      "class_label": "Tree",
      "score": 0.11284389346837997
    },
    {
      "box": [
        0.3652540445327759,
        0.16809366643428802,
        0.6130281686782837,
        0.36443042755126953
      ],
      "class_label": "House",
      "score": 0.11282401531934738
    },
    {
      "box": [
        0.0,
        0.9386014342308044,
        0.06958888471126556,
        0.9980760216712952
      ],
      "class_label": "Tree",
      "score": 0.11164987087249756
    },
    {
      "box": [
        0.28936702013015747,
        0.15896916389465332,
        0.5307056307792664,
        0.3148036301136017
      ],
      "class_label": "Tree",
      "score": 0.11015014350414276
    },
    {
      "box": [
        0.6670478582382202,
        0.3887351155281067,
        0.8320544958114624,
        0.6814133524894714
      ],
      "class_label": "Boat",
      "score": 0.11006134748458862
    },
    {
      "box": [
        0.8134007453918457,
        0.6632328629493713,
        0.9972208738327026,
        0.8286282420158386
      ],
      "class_label": "Tree",
      "score": 0.10983387380838394
    },
    {
      "box": [
        0.4209780693054199,
        0.3316228985786438,
        0.6759926080703735,
        0.5263915061950684
      ],
      "class_label": "House",
      "score": 0.10911168158054352
    },
    {
      "box": [
        0.24462303519248962,
        0.42682451009750366,
        0.3025576174259186,
        0.4800402522087097
      ],
      "class_label": "Plant",
      "score": 0.10903934389352798
    },
    {
      "box": [
        0.011912381276488304,
        0.5802666544914246,
        0.06914063543081284,
        0.6517297625541687
      ],
      "class_label": "Airplane",
      "score": 0.1087624579668045
    },
    {
      "box": [
        0.26262789964675903,
        0.25523728132247925,
        0.3423474431037903,
        0.3262186050415039
      ],
      "class_label": "Plant",
      "score": 0.10777866095304489
    },
    {
      "box": [
        0.0,
        0.7207410335540771,
        0.7562097311019897,
        0.998910665512085
      ],
      "class_label": "Tree",
      "score": 0.10562631487846375
    },
    {
      "box": [
        0.15078653395175934,
        0.2600252628326416,
        0.40503495931625366,
        0.6413062810897827
      ],
      "class_label": "Tree",
      "score": 0.10490282624959946
    },
    {
      "box": [
        0.3480182886123657,
        0.24552583694458008,
        0.7577913999557495,
        0.7203543782234192
      ],
      "class_label": "House",
      "score": 0.1046571210026741
    },
    {
      "box": [
        0.02555704116821289,
        0.6101475954055786,
        0.9049587249755859,
        0.9687470197677612
      ],
      "class_label": "Tree",
      "score": 0.1042347401380539
    },
    {
      "box": [
        0.2581653594970703,
        0.39187440276145935,
        0.29152339696884155,
        0.41820457577705383
      ],
      "class_label": "Plant",
      "score": 0.10368663817644119
    },
    {
      "box": [
        0.2689754366874695,
        0.6052817702293396,
        0.2910482883453369,
        0.622316300868988
      ],
      "class_label": "Plant",
      "score": 0.10356206446886063
    },
    {
      "box": [
        0.10394558310508728,
        0.26530641317367554,
        0.43315550684928894,
        0.8042925000190735
      ],
      "class_label": "Tree",
      "score": 0.10348329693078995
    },
    {
      "box": [
        0.0,
        0.29799994826316833,
        0.28353357315063477,
        0.9826703071594238
      ],
      "class_label": "Tree",
      "score": 0.1031816229224205
    },
    {
      "box": [
        0.015969187021255493,
        0.6212643384933472,
        0.5357552766799927,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.10286955535411835
    },
    {
      "box": [
        0.2118474543094635,
        0.543790876865387,
        0.2539110779762268,
        0.585698664188385
      ],
      "class_label": "Plant",
      "score": 0.1018080860376358
    },
    {
      "box": [
        0.7101479768753052,
        0.3622039258480072,
        0.8023159503936768,
        0.43830886483192444
      ],
      "class_label": "Boat",
      "score": 0.1011224314570427
    },
    {
      "box": [
        0.7090221643447876,
        0.39429518580436707,
        0.7966017723083496,
        0.5021605491638184
      ],
      "class_label": "Boat",
      "score": 0.10049198567867279
    },
    {
      "box": [
        0.8061767816543579,
        0.592870831489563,
        1.0,
        0.759848952293396
      ],
      "class_label": "Tree",
      "score": 0.09964444488286972
    },
    {
      "box": [
        0.21808351576328278,
        0.6525909900665283,
        0.24681876599788666,
        0.6882011890411377
      ],
      "class_label": "Plant",
      "score": 0.09946295619010925
    },
    {
      "box": [
        0.0018852651119232178,
        0.27059048414230347,
        0.23812085390090942,
        0.6307054758071899
      ],
      "class_label": "Tree",
      "score": 0.09939130395650864
    },
    {
      "box": [
        0.012045949697494507,
        0.25784042477607727,
        0.33382532000541687,
        0.8038713932037354
      ],
      "class_label": "Tree",
      "score": 0.09879393875598907
    },
    {
      "box": [
        0.0,
        0.5229080319404602,
        0.27136027812957764,
        0.6917849183082581
      ],
      "class_label": "Tree",
      "score": 0.09873265773057938
    },
    {
      "box": [
        0.34493204951286316,
        0.3229154944419861,
        0.37497249245643616,
        0.3477863669395447
      ],
      "class_label": "Plant",
      "score": 0.09852129220962524
    },
    {
      "box": [
        0.25162985920906067,
        0.9288293123245239,
        0.30036166310310364,
        0.954049825668335
      ],
      "class_label": "Person",
      "score": 0.09845790266990662
    },
    {
      "box": [
        0.0,
        0.8449246287345886,
        0.5269250869750977,
        0.9954543709754944
      ],
      "class_label": "Tree",
      "score": 0.09810318052768707
    },
    {
      "box": [
        0.675670862197876,
        0.3678063452243805,
        0.8263858556747437,
        0.5825199484825134
      ],
      "class_label": "Boat",
      "score": 0.0974501520395279
    },
    {
      "box": [
        0.0,
        0.5854588150978088,
        0.17790353298187256,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.09707684814929962
    },
    {
      "box": [
        0.7867748141288757,
        0.6171131730079651,
        0.9894437193870544,
        0.7942858338356018
      ],
      "class_label": "Plant",
      "score": 0.09682167321443558
    },
    {
      "box": [
        0.44036784768104553,
        0.20669260621070862,
        0.674767017364502,
        0.39988020062446594
      ],
      "class_label": "House",
      "score": 0.09680036455392838
    },
    {
      "box": [
        0.2816454768180847,
        0.6591096520423889,
        0.30704593658447266,
        0.6805939078330994
      ],
      "class_label": "Plant",
      "score": 0.09642255306243896
    },
    {
      "box": [
        0.22421273589134216,
        0.39402520656585693,
        0.27615854144096375,
        0.4937441945075989
      ],
      "class_label": "Plant",
      "score": 0.09504042565822601
    },
    {
      "box": [
        0.40832215547561646,
        0.2637817859649658,
        0.6828270554542542,
        0.6192426681518555
      ],
      "class_label": "House",
      "score": 0.0948953628540039
    },
    {
      "box": [
        0.23673541843891144,
        0.5872274041175842,
        0.26243260502815247,
        0.6129055619239807
      ],
      "class_label": "Plant",
      "score": 0.09322962909936905
    },
    {
      "box": [
        0.0,
        0.3226572871208191,
        0.582886815071106,
        0.9763700366020203
      ],
      "class_label": "Tree",
      "score": 0.09293770790100098
    },
    {
      "box": [
        0.10128146409988403,
        0.8609327077865601,
        0.7992501258850098,
        1.0
      ],
      "class_label": "Tree",
      "score": 0.09288381785154343
    },
    {
      "box": [
        0.32153648138046265,
        0.550379753112793,
        0.3559344410896301,
        0.5687993764877319
      ],
      "class_label": "Plant",
      "score": 0.09268514811992645
    },
    {
      "box": [
        0.2058878242969513,
        0.3618021607398987,
        0.2903830111026764,
        0.615004301071167
      ],
      "class_label": "Plant",
      "score": 0.09257910400629044
    },
    {
      "box": [
        0.0,
        0.42458218336105347,
        0.1561579555273056,
        0.5747113227844238
      ],
      "class_label": "Tree",
      "score": 0.09248140454292297
    },
    {
      "box": [
        0.6334682106971741,
        0.8644493222236633,
        0.6979318261146545,
        0.9032126069068909
      ],
      "class_label": "Plant",
      "score": 0.09200501441955566
    },
    {
      "box": [
        0.05220121145248413,
        0.2387751191854477,
        0.3051533102989197,
        0.4430467486381531
      ],
      "class_label": "Tree",
      "score": 0.09170606732368469
    },
    {
      "box": [
        0.0028283894062042236,
        0.664528489112854,
        0.30893674492836,
        0.9978421926498413
      ],
      "class_label": "Tree",
      "score": 0.09155550599098206
    },
    {
      "box": [
        0.17711487412452698,
        0.3749615252017975,
        0.3507261574268341,
        0.5446664094924927
      ],
      "class_label": "Tree",
      "score": 0.09147986769676208
    },
    {
      "box": [
        0.012626230716705322,
        0.15186858177185059,
        0.3133571147918701,
        0.6622656583786011
      ],
      "class_label": "Tree",
      "score": 0.09146714210510254
    },
    {
      "box": [
        0.0034622400999069214,
        0.11578217148780823,
        0.16511596739292145,
        0.7295018434524536
      ],
      "class_label": "Tree",
      "score": 0.0912548154592514
    },
    {
      "box": [
        0.7989119291305542,
        0.6608681082725525,
        0.9587228298187256,
        0.7678847908973694
      ],
      "class_label": "Plant",
      "score": 0.09121359884738922
    },
    {
      "box": [
        0.2536655068397522,
        0.5347157120704651,
        0.29834800958633423,
        0.5674381852149963
      ],
      "class_label": "Plant",
      "score": 0.09109406173229218
    },
    {
      "box": [
        0.12232422828674316,
        0.3224531412124634,
        0.4555521607398987,
        0.6024723649024963
      ],
      "class_label": "Tree",
      "score": 0.09091827273368835
    },
    {
      "box": [
        0.23128527402877808,
        0.38884785771369934,
        0.28329354524612427,
        0.44319042563438416
      ],
      "class_label": "Tree",
      "score": 0.09086224436759949
    },
    {
      "box": [
        0.8345955610275269,
        0.6405103206634521,
        0.9341553449630737,
        0.687132716178894
      ],
      "class_label": "Tree",
      "score": 0.09065357595682144
    },
    {
      "box": [
        0.37391090393066406,
        0.08631996810436249,
        0.6138029098510742,
        0.21232818067073822
      ],
      "class_label": "Tree",
      "score": 0.0905279889702797
    },
    {
      "box": [
        0.0,
        0.3734774589538574,
        0.20662987232208252,
        0.5286591649055481
      ],
      "class_label": "Tree",
      "score": 0.09033409506082535
    },
    {
      "box": [
        0.036188431084156036,
        0.21283268928527832,
        0.20122000575065613,
        0.5094069838523865
      ],
      "class_label": "Tree",
      "score": 0.09022852778434753
    },
    {
      "box": [
        0.36929237842559814,
        0.7791362404823303,
        0.3965848684310913,
        0.7917556166648865
      ],
      "class_label": "Wheel",
      "score": 0.08935349434614182
    },
    {
      "box": [
        0.0013931170105934143,
        0.3615686893463135,
        0.14560189843177795,
        0.6770365238189697
      ],
      "class_label": "Tree",
      "score": 0.0890316441655159
    },
    {
      "box": [
        0.33062276244163513,
        0.6097952723503113,
        0.3608129918575287,
        0.6292193531990051
      ],
      "class_label": "Plant",
      "score": 0.08878225833177567
    },
    {
      "box": [
        0.3764326274394989,
        0.2032124251127243,
        0.6655548810958862,
        0.5128739476203918
      ],
      "class_label": "House",
      "score": 0.08852851390838623
    },
    {
      "box": [
        0.8747143149375916,
        0.6379626989364624,
        0.968931257724762,
        0.6908375024795532
      ],
      "class_label": "Tree",
      "score": 0.0882948562502861
    },
    {
      "box": [
        0.6446618437767029,
        0.41452670097351074,
        0.8501697182655334,
        0.5706976056098938
      ],
      "class_label": "Boat",
      "score": 0.08821132779121399
    },
    {
      "box": [
        0.0,
        0.325715571641922,
        0.34533512592315674,
        0.5963647365570068
      ],
      "class_label": "Tree",
      "score": 0.08820027858018875
    },
    {
      "box": [
        0.2205088585615158,
        0.48870113492012024,
        0.2736632227897644,
        0.536262571811676
      ],
      "class_label": "Plant",
      "score": 0.08781834691762924
    },
    {
      "box": [
        0.003461495041847229,
        0.49144870042800903,
        0.13140109181404114,
        0.7131924033164978
      ],
      "class_label": "Tree",
      "score": 0.08770021051168442
    },
    {
      "box": [
        0.5022740364074707,
        0.3795798718929291,
        0.5407686233520508,
        0.4099249541759491
      ],
      "class_label": "Window",
      "score": 0.08760303258895874
    },
    {
      "box": [
        0.04475880414247513,
        0.3571043908596039,
        0.2001798152923584,
        0.6430883407592773
      ],
      "class_label": "Tree",
      "score": 0.0876014307141304
    },
    {
      "box": [
        0.2253779172897339,
        0.21557998657226562,
        0.36209017038345337,
        0.4398311972618103
      ],
      "class_label": "Plant",
      "score": 0.0871826708316803
    },
    {
      "box": [
        0.33931559324264526,
        0.3092912435531616,
        0.6329852342605591,
        0.7524505853652954
      ],
      "class_label": "House",
      "score": 0.08706199377775192
    }
  ]
}')

 function Get-AIAnalysis {
    param (
        [Parameter(Mandatory = $true)]
        [string]
        $URL,

        [Parameter(HelpMessage = "mobilenet is a precice one which takes longer. efficientdet is a quick small allrounder")]
        [ValidateSet('https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1', 
            'tensorflow/efficientdet/tensorFlow2/d0')]
        [string]
        $Model = 'tensorflow/efficientdet/tensorFlow2/d0',

        [Parameter()]
        [bool]
        $RawOutput = $false
    )
    
    try {
       
        $stdout = python /data/main.py --url $URL --model $Model # Real Analysis
        #$stdout = $FAKETESTDATA # Fake Data for Dev

        # Use regex to find the JSON part
        $jsonObject = [regex]::Match($stdout, '\{(?:[^{}]|(?<o>\{)|(?<-o>\}))+(?(o)(?!))\}').Value
        
        # Output the captured output
        if ($RawOutput) {
            Return ($stdout | Out-String) 
        } else {
            if ((($jsonObject | convertfrom-json).detections.count) -ne 0) {
                Return ((($jsonObject | convertfrom-json).detections) | Select-Object class_label, score)
            }
            else {
                Return ('{ "Error":  "No Objects found on picture, script output: ' + $stdout + '" }')  
            }
        }
    }
    catch {
        Return ('{ "Error":  "' + $_.Exception.Message + '" }')  
    }
} 

function Get-NavMenuHTML {
    param (
        [Parameter()]
        [ValidateSet('scheduled-counts', 'test', 'info', 'swagger', 'phpMyAdmin')]
        [string]
        $ActiveItem
    )

    switch ($ActiveItem) {
        "scheduled-counts" { $scheduledCountsActiveFlag = "active" }
        "info" { $infoActiveFlag = "active" }
        "test" { $testActiveFlag = "active" }
        "swagger" { $swaggerActiveFlag = "active" }
        Default {}
    }

    $HTML = ('
        <nav class="navbar navbar-expand-sm bg-body-tertiary rounded">
            <div class="container-xxl">
                <a class="navbar-brand" href="#">AI-Object Counter</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar"
                    aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbar">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link ' + $scheduledCountsActiveFlag + '" href="/">Scheduled Counts</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link ' + $testActiveFlag + '" href="/test">Test</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link ' + $infoActiveFlag + '" href="/info">Info</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link ' + $swaggerActiveFlag + '" href="/swagger-api">API Docu (Swagger)</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>')

    Return $HTML
}

function Get-AvailableAiModels {
    param (
        [Parameter()]
        [switch]
        $OutputAsHTMLOptions,

        [Parameter()]
        [switch]
        $OutputAsHTMLCards
    )

    if ($OutputAsHTMLOptions) {
        Return ('<option>https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1</option>
        <option>tensorflow/efficientdet/tensorFlow2/d0</option>')
    }
    elseif ($OutputAsHTMLCards) {
        Return ('<div class="card-group">
        <div class="card" style="width: 18rem;">
        <div class="card-body">
          <h5 class="card-title">mobilenet_v2</h5>
          <h6 class="card-subtitle mb-2 text-body-secondary"><i>by Google</i></h6>
          <p class="card-text">SSD-based object detection model trained on Open Images V4 with ImageNet pre-trained MobileNet V2 as image feature extractor.</p>
          <a href="https://www.kaggle.com/models/google/mobilenet-v2/tensorFlow1/openimages-v4-ssd-mobilenet-v2/1?tfhub-redirect=true" target="_blank" class="card-link">Further Info</a>
        </div>
      </div>
      <div class="card" style="width: 18rem;">
        <div class="card-body">
          <h5 class="card-title">efficientdet</h5>
          <h6 class="card-subtitle mb-2 text-body-secondary"><i>by tensorflow</i></h6>
          <p class="card-text">EfficientDet Object detection model (SSD with EfficientNet-b0 + BiFPN feature extractor, shared box predictor and focal loss), trained on COCO 2017 dataset.</p>
          <a href="https://www.kaggle.com/models/tensorflow/efficientdet/tensorFlow2/d0/1?tfhub-redirect=true" target="_blank" class="card-link">Further Info</a>
        </div>
      </div>
      </div>')
    } 
    else {
        Return ("https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1", "tensorflow/efficientdet/tensorFlow2/d0")
    }
}

function Get-ToastHTML {
    param (
        [Parameter()]
        [string]
        $ToastHeader,

        [Parameter()]
        [string]
        $ToastIcon,

        [Parameter()]
        [string]
        $ToastBody
    )
    
    return (('<div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                ' + $ToastIcon + '
            <strong class="me-auto">' + $ToastHeader + '</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ' + $ToastBody + '
            </div>
        </div>
    </div>'))

}

function Set-ScheduledCountJob {
    param (
        [Parameter()]
        [Int]
        $ID,
    
        [Parameter()]
        [String]
        $JobName,

        [Parameter()]
        [String]
        $Model,

        [Parameter()]
        [String]
        $Object,

        [Parameter()]
        [Int]
        $FrequencyMinutes,

        [Parameter()]
        [String]
        $URL,

        [Parameter()]
        [bool]
        $Enabled = $true,

        [Parameter()]
        [switch]
        $Enable,

        [Parameter()]
        [switch]
        $Disable
    )

    if ($Enabled) { $EnabledString = 1 } else { $EnabledString = 0 }

    if ($Enable -and $null -ne $ID) {
        Invoke-SqlUpdate -Query ("UPDATE ``scheduledcounts`` SET ``enabled`` = '1' WHERE ``scheduledcounts``.``id`` = " + $ID + ";")
        Return 0
    }
    elseif ($Disable -and $null -ne $ID) {
        Invoke-SqlUpdate -Query ("UPDATE ``scheduledcounts`` SET ``enabled`` = '0' WHERE ``scheduledcounts``.``id`` = " + $ID + ";")
        Return 0
    }

    Open-MySqlConnection -CommandTimeout 5000 -Server $env:MariaDBHost -Port $env:MariaDBPort -Credential (New-Object System.Management.Automation.PSCredential ($env:MariaDBUsername, (ConvertTo-SecureString $env:MariaDBPassword -AsPlainText -Force))) -Database $env:MariaDBDatabase -WarningAction SilentlyContinue -ErrorAction Stop
    if ($null -ne $ID -and $ID -ne "" -and !$Enable -and !$Disable) {
        try {
            Invoke-SqlUpdate -Query ("UPDATE `scheduledcounts` SET `jobname` = '" + $JobName + "', `model` = '" + $Model + "', `object` = '" + $Object + "', `frequencymin` = '" + $FrequencyMinutes + "', `URL` = '" + $URL + "', `enabled` = '" + $EnabledString + "' WHERE `scheduledcounts`.`id` = " + $ID + ";") -ErrorAction Stop
            Return 0
        }
        catch {
            Throw $_.Exception.Message
        }

    }
    else {
        try {
            Invoke-SqlUpdate -Query ("INSERT INTO ``scheduledcounts`` (``id``, ``jobname``, ``model``, ``object``, ``frequencymin``, ``URL``, ``enabled``, ``created``, `lastchanged`) 
            VALUES (NULL, '" + $JobName + "', '" + $Model + "', '" + $Object + "', '" + $FrequencyMinutes + "', '" + $URL + "', '" + $EnabledString + "', current_timestamp(), current_timestamp());") -ErrorAction Stop
            Return 0
        }
        catch {
            Throw $_.Exception.Message
        }
    }
}

function Get-ScheduledCountJob {
    param (
        [Parameter()]
        [switch]
        $AsHTMLTable
    )

    Open-MySqlConnection -CommandTimeout 5000 -Server $env:MariaDBHost -Port $env:MariaDBPort -Credential (New-Object System.Management.Automation.PSCredential ($env:MariaDBUsername, (ConvertTo-SecureString $env:MariaDBPassword -AsPlainText -Force))) -Database $env:MariaDBDatabase -WarningAction SilentlyContinue -ErrorAction Stop
    
    try {
        $Return = Invoke-SqlQuery -Query "SELECT * FROM ``scheduledcounts``" -ErrorAction Stop
    }
    catch {
        $Return = $_.Exception.Message
    }
    
    if ($AsHTMLTable) {
        $ReturnHTMLTable = ('<table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Jobname</th>
                <th scope="col">AI Model</th>
                <th scope="col">Object</th>
                <th scope="col">Frequency</th>
                <th scope="col">URL</th>
                <th scope="col">Datatable Row Count</th>
                <th scope="col">Last count Date/Time</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            ')
        $Return | ForEach-Object {
            switch ($_.model) {
                "openimages_v4/ssd/mobilenet_v2/1" { $ModelLabel = "mobilenet" }
                "tensorflow/efficientdet/tensorFlow2/d0" { $ModelLabel = "efficientdet" }
                Default { $ModelLabel = $_.model }
            }
            switch ($_.enabled) {
                $false { $StatusIconButton = '<button type="submit" class="btn btn-outline-light" data-toggle="tooltip" data-placement="top" title="Scheduled Task is turned off right now, click to turn on"><i class="bi bi-play"></i></button>' }
                $True { $StatusIconButton = '<button type="submit" class="btn btn-outline-light" data-toggle="tooltip" data-placement="top" title="Scheduled Task is turned on right now, click to turn off"><i class="bi bi-pause"></i></button>' }
            }
            $ReturnHTMLTable = $ReturnHTMLTable + ('<tr>
            <th scope="row">' + $_.id + '</th>
            <td><b>' + $_.jobname + '</b></td>
            <td><b>' + $ModelLabel + '</b></td>
            <td>' + $_.object + '</td>
            <td>' + $_.frequencymin + ' min</td>
            <td ><a href="' + $_.URL + '"><p class="text-break">' + $_.URL + '</p></a></td>
            <td>tbp</td>
            <td>tbp</td>
            <td>
                <div class="btn-group" role="group">
                <!-- <button type="submit" class="btn btn-outline-primary" data-toggle="tooltip" data-placement="top" title="Edit"><i class="bi bi-pencil"></i></button> -->
                <button type="button" class="btn btn-outline-secondary"data-toggle="tooltip" data-placement="top" title="Inspect collected Data"><i
                class="bi bi-eye"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-toggle="tooltip" data-placement="top" title="Download all collected Data as CSV"><i
                class="bi bi-download"></i></button>
                <form action="/" method="post">
                    ' + $StatusIconButton + '
                    <input type="hidden" name="action" value="changestate">
                    <input type="hidden" name="id" value="' + $_.id + '">
                </form>
                <form action="/" method="post">
                        <button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash3"></i></button>
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="id" value="' + $_.id + '" required>
                    </form>
                </div>
            </td>
        </tr>
        ')
        }
        $ReturnHTMLTable = $ReturnHTMLTable + ('</tbody>
    </table>')
        $Return = $ReturnHTMLTable
    } 

    Return $Return
}

function Remove-ScheduledCountJob {
    param (
        [Parameter(Mandatory = $true)]
        [Int]
        $Id
    )
        
    try {
        Open-MySqlConnection -CommandTimeout 5000 -Server $env:MariaDBHost -Port $env:MariaDBPort -Credential (New-Object System.Management.Automation.PSCredential ($env:MariaDBUsername, (ConvertTo-SecureString $env:MariaDBPassword -AsPlainText -Force))) -Database $env:MariaDBDatabase -WarningAction SilentlyContinue -ErrorAction Stop
        $Return = Invoke-SqlUpdate -Query ("DELETE FROM scheduledcounts WHERE `scheduledcounts`.`id` = " + $Id)
        Return $Return
    }
    catch {
        Return $_.Exception.Message
    }
}


function Get-GPUInfo {
    param (
        [Parameter()]
        [switch]
        $AsHTMLTable
    )

    try {
        $pinfo = New-Object System.Diagnostics.ProcessStartInfo
        $pinfo.FileName = "lshw"
        $pinfo.RedirectStandardError = $true
        $pinfo.RedirectStandardOutput = $true
        $pinfo.UseShellExecute = $false
        $pinfo.Arguments = ("-C display -json")
        $p = New-Object System.Diagnostics.Process
        $p.StartInfo = $pinfo
        $p.Start() | Out-Null
        $p.WaitForExit()
        $stdout = $p.StandardOutput.ReadToEnd()

        $Return = $stdout | ConvertFrom-Json
        if ($AsHTMLTable) {
            $HTMLTable = "<table>"
            $Return | Get-Member -Type NoteProperty | ForEach-Object {
                $HTMLTable += "<tr>"
                $HTMLTable += "    <td><b>" + $_.name + "</b></td>"
                if ($_.name -ieq "configuration" -or $_.name -ieq "capabilities") {
                    $HTMLTable += "    <td>" + ($Return.($_.name) | ConvertTo-Html -Fragment) + "</td>"
                }
                else {
                    $HTMLTable += "    <td>" + $Return.($_.name) + "</td>"
                }
                $HTMLTable += "</tr>"
            }
            $HTMLTable += "</table>"
            
            $Return.configuration = $Return.configuration | ConvertTo-Html -Fragment
            $Return.capabilities = $Return.capabilities | ConvertTo-Html -Fragment
            $Return = $HTMLTable -join ""
        }
        Return $Return
    }
    catch {
        Return $_.Exception.Message
    }
    

}