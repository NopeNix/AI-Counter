<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/konva/7.2.5/konva.min.js"></script>
  <style>
    #container {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    var width = 800;
    var height = 600;

    var stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height,
    });

    var layer = new Konva.Layer();
    stage.add(layer);

    var imageObj = new Image();
    imageObj.src = 'https://webcam.wpzw.de/webcam.jpg';  // Replace with your image URL
    imageObj.onload = function() {
      var yoda = new Konva.Image({
        x: 0,
        y: 0,
        image: imageObj,
        width: width,
        height: height,
      });
      layer.add(yoda);
      layer.draw();

      // Initialize drawing functionality after the image is loaded
      initializeDrawing();
    };

    var rect = new Konva.Rect({
      x: 0,
      y: 0,
      width: 0,
      height: 0,
      stroke: 'red',
      strokeWidth: 5,
      draggable: true,
    });

    var tr = new Konva.Transformer({
      nodes: [rect],
      enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right', 'top-center', 'bottom-center', 'middle-left', 'middle-right'],
      rotateEnabled: false,
      boundBoxFunc: function (oldBox, newBox) {
        // Set minimum width and height
        if (newBox.width < 20 || newBox.height < 20) {
          return oldBox;
        }
        // Restrict movement within the canvas bounds
        if (newBox.x < 0 || newBox.y < 0 || newBox.x + newBox.width > width || newBox.y + newBox.height > height) {
          return oldBox;
        }
        return newBox;
      },
    });

    function initializeDrawing() {
      layer.add(rect);
      layer.add(tr);

      var isDrawing = false;
      stage.on('mousedown', function(evt) {
        if (rect.width() === 0 && rect.height() === 0) {
          isDrawing = true;
          var pos = stage.getPointerPosition();
          rect.x(pos.x);
          rect.y(pos.y);
          rect.width(0);
          rect.height(0);
          layer.draw();
        }
      });

      stage.on('mousemove', function(evt) {
        if (!isDrawing) return;
        var pos = stage.getPointerPosition();
        rect.width(Math.max(pos.x - rect.x(), 20));
        rect.height(Math.max(pos.y - rect.y(), 20));
        layer.draw();
      });

      stage.on('mouseup', function(evt) {
        isDrawing = false;
        console.log('Rectangle coordinates: ', rect.x(), rect.y(), rect.width(), rect.height());
        // You can now use these coordinates for further processing
      });

      // Disable further drawing once the rectangle is drawn
      stage.on('click', function(evt) {
        if (!isDrawing && rect.width() > 0 && rect.height() > 0) {
          isDrawing = false;
        }
      });

      // Constrain dragging within the canvas
      rect.on('dragmove', function() {
        var box = rect.getClientRect();
        if (box.x < 0) {
          rect.x(0);
        }
        if (box.y < 0) {
          rect.y(0);
        }
        if (box.x + box.width > width) {
          rect.x(width - box.width);
        }
        if (box.y + box.height > height) {
          rect.y(height - box.height);
        }
      });
    }
  </script>
</body>
</html>